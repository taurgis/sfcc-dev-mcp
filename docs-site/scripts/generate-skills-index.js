#!/usr/bin/env node

/**
 * Skills Index Generator for SFCC Dev MCP docs site
 *
 * Generates a small TypeScript module that contains metadata about the bundled
 * agent skills under ai-instructions/skills/<skill>/SKILL.md.
 *
 * This keeps the docs-site Skills page in sync without requiring runtime FS access.
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const REPO_ROOT = path.resolve(__dirname, '../..');
const SKILLS_DIR = path.join(REPO_ROOT, 'ai-instructions', 'skills');
const OUTPUT_FILE = path.join(__dirname, '..', 'src', 'generated-skills-index.ts');

const GITHUB_BASE = 'https://github.com/taurgis/sfcc-dev-mcp';

function parseFrontmatter(markdown) {
  const lines = markdown.split(/\r?\n/);
  if (!lines.length || lines[0].trim() !== '---') return null;

  let endIndex = -1;
  for (let i = 1; i < lines.length; i++) {
    if (lines[i].trim() === '---') {
      endIndex = i;
      break;
    }
  }
  if (endIndex === -1) return null;

  const fmLines = lines.slice(1, endIndex);
  const obj = {};

  for (const line of fmLines) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#')) continue;
    const idx = trimmed.indexOf(':');
    if (idx === -1) continue;

    const key = trimmed.slice(0, idx).trim();
    let value = trimmed.slice(idx + 1).trim();

    if ((value.startsWith('"') && value.endsWith('"')) || (value.startsWith("'") && value.endsWith("'"))) {
      value = value.slice(1, -1);
    }

    obj[key] = value;
  }

  return obj;
}

function findSkillDirs() {
  if (!fs.existsSync(SKILLS_DIR)) {
    throw new Error('Skills directory not found: ' + SKILLS_DIR);
  }

  return fs
    .readdirSync(SKILLS_DIR, { withFileTypes: true })
    .filter((d) => d.isDirectory())
    .map((d) => d.name)
    .filter((dirName) => fs.existsSync(path.join(SKILLS_DIR, dirName, 'SKILL.md')));
}

function generate() {
  const skillDirs = findSkillDirs();

  const skills = skillDirs
    .map((dirName) => {
      const skillFile = path.join(SKILLS_DIR, dirName, 'SKILL.md');
      const markdown = fs.readFileSync(skillFile, 'utf8');
      const fm = parseFrontmatter(markdown) ?? {};

      const name = fm.name || dirName;
      const description = fm.description || '';
      const githubUrl = GITHUB_BASE + '/blob/main/ai-instructions/skills/' + dirName + '/SKILL.md';

      return {
        name,
        description,
        dirName,
        githubUrl,
      };
    })
    .sort((a, b) => a.name.localeCompare(b.name));

  const fileHeader = [
    '// AUTO-GENERATED FILE. DO NOT EDIT MANUALLY.',
    '//',
    '// Generated by: docs-site/scripts/generate-skills-index.js',
    '// Source: ai-instructions/skills/*/SKILL.md',
    '',
    'export interface SkillMeta {',
    '  name: string;',
    '  description: string;',
    '  dirName: string;',
    '  githubUrl: string;',
    '}',
    '',
  ].join('\n');

  const fileContent =
    fileHeader +
    'export const SKILLS: SkillMeta[] = ' +
    JSON.stringify(skills, null, 2) +
    ' as const;\n';

  fs.mkdirSync(path.dirname(OUTPUT_FILE), { recursive: true });
  fs.writeFileSync(OUTPUT_FILE, fileContent, 'utf8');

  console.log('Generated skills index: ' + path.relative(REPO_ROOT, OUTPUT_FILE));
  console.log('Skills included: ' + skills.length);
}

try {
  generate();
} catch (err) {
  console.error('Failed to generate skills index:', err);
  process.exitCode = 1;
}
