name: Publish to NPM

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Setup SFCC mock server
        run: |
          cd tests/servers/sfcc-mock-server
          npm install
          npm run setup:logs
          node server.js --port 3000 &
          sleep 5

      - name: Run tests
        run: npm test

      - name: Run linting
        run: npm run lint:check

      - name: Final build for publishing
        run: npm run build

      - name: Extract version and create release branch
        run: |
          # Extract version from the release tag (remove 'v' prefix if present)
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "Setting package version to: $VERSION"
          
          # Create and switch to release branch
          BRANCH_NAME="release/v$VERSION"
          echo "Creating release branch: $BRANCH_NAME"
          git checkout -b $BRANCH_NAME

          # Update package version
          npm version $VERSION --no-git-tag-version

          # Commit the version update
          git add package.json package-lock.json
          git commit -m "chore: bump version to $VERSION for release"

          # Push the release branch
          git push origin $BRANCH_NAME

      - name: Publish to NPM
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Wait for npm propagation buffer
        run: |
          echo "Waiting 120 seconds for npm registry/CDN propagation before post-publish tests..."
          sleep 120

      - name: Run post-publish MCP tests against published NPX package
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          bash ./scripts/test-published-npx.sh "$VERSION"

      - name: Stop SFCC mock server
        if: always()
        run: |
          # Stop the single mock server instance used by both pre- and post-publish MCP tests.
          pkill -f "node.*server.js" || true
          # Fallback: kill any remaining server processes on port 3000
          lsof -ti :3000 | xargs kill -9 2>/dev/null || true

      - name: Install MCP Publisher
        run: |
          OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
          ARCH="$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/')"
          PUBLISHER_URL="https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_${OS}_${ARCH}.tar.gz"

          curl --fail --silent --show-error --location "$PUBLISHER_URL" --output mcp-publisher.tar.gz
          tar xzf mcp-publisher.tar.gz mcp-publisher
          chmod +x mcp-publisher
          rm -f mcp-publisher.tar.gz

      - name: Update server.json version
        run: |
          # Extract version from the release tag (remove 'v' prefix if present)
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "Updating server.json version to: $VERSION"
          
          # Update server.json version to match the release
          jq --arg v "$VERSION" '.version = $v | .packages[0].version = $v' server.json > tmp && mv tmp server.json

      - name: Validate server.json
        run: npm run validate:server-json

      - name: Login to MCP Registry
        run: ./mcp-publisher login github-oidc

      - name: Publish to MCP Registry
        run: ./mcp-publisher publish
